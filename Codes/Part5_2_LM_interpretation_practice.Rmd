---
title: "Linear Regression_Pracice_HIV"
output:
  pdf_document: default
  html_document: default
date: "2024-11-16"
---

It is often the case that we need to linear and/or log transform data to be able to fit a linear model and enhance interpretation. Also In this exercise, we will consider three questions:\
1) How is the level of HIV RNA (a measure of the viral load in the bloodstream, exposure) associated with depression scores (outcome)\
2) Change of depression across age\    
3) Level of HIV RNA and sex (female vs male)   

In the file `HIV-eg_data.csv`, you have data from a sample of 5000 individuals with HIV. As this is a cross-sectional study, we are only able to examine associations and will not be able to determine causation (that is, our regression model can only test whether “x and y are associated” but not whether “x affects y”, without temporal relationship that cannot be achieved if not generated by cohort (longitudinal) data collection).

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(epitools)
library(gridExtra)


#Refresh environment 
rm(list=ls())

# transfortion 
#log2(x)# base 2
#log10(x) # base 10
#log(x) # natural log
```

Get Data and prepare variables

```{r}
hiv <- read.csv("https://raw.githubusercontent.com/hiroshimamiya/EPIB607/refs/heads/main/Data/HIV_eg_data.csv")                         


hiv$age <- (rbeta(nrow(hiv),2,4)*30+20) + log(hiv$RNA) 
hiv$ageGroup <- as.factor(cut(hiv$age, breaks=c(0, 20, 35, 60), labels=c('teen', 'young', 'mid')))
hiv$female <-  as.factor(rbinom(n=nrow(hiv), size=1, prob=0.4) )
hiv$RNA <- hiv$RNA  
  
glimpse(hiv)
str(hiv)
class(hiv)

# Transform RNA, log base e, base 2, (optional) base 10
hiv$RNA2 <- log2(hiv$RNA)
hiv$RNAe <- log(hiv$RNA)

```

# Plot variables

```{r, fig.width=9, fig.height=4}
# Descriptive 
summary(hiv)
table(hiv$ageGroup)
table(hiv$female)


# Plot descriptive 
par(mfrow=c(1,4))
hist(hiv$RNA); hist(hiv$depression); hist(hiv$art); hist(hiv$age)
grid.arrange(
  ggplot(data = hiv, aes(x = RNA, y = depression)) + geom_point() + theme_classic() + ggtitle("depression score vs. RNA"),
  ggplot(data = hiv, aes(x = RNA, y = age)) + geom_point() + theme_classic() + ggtitle("Age vs. RNA"),
  ggplot(data = hiv, aes(  ageGroup, RNA))  + geom_boxplot() + theme_classic() + ggtitle("RNA across age groups"),
  ggplot(data = hiv, aes(  female, RNA))  + geom_boxplot() + theme_classic()  + ggtitle("RNA across sex")
)

```

# First, go through the codes for least square estimation before working on Questions 1-7 about interpretation.    
The estimation can be achive by the calculation of SSxy, SSxx, $\overline{y}$, and $\overline{x}$ manually, or    
Alternatively, R code `lm` can be used as below. To estimate betas, write `lm(outcome ~ exposure, data= data)`.      

Either approach is fine to estimate the model below, 

$y = \beta_0 + \beta_1 \times x + \epsilon$

Estimate the beta coefficients (parameters)\
$\beta_0, \beta_1$ and once find these, then find the values of "y hat" (fitted, estimated y) as\
$\hat{y} = \hat{\beta_0} + \hat{\beta_1} \times x$\
Then estimate errors $\epsilon$ as\
$\hat{e} = y - \hat{y}$, for each data point.

```{r}
x <- hiv$RNA
y <- hiv$depression

# Least square estimation 
# Beta_1
SS_xy <- sum((x - mean(x))*(y - mean(y))) 
SS_xx <- sum((x - mean(x))^2)
beta_1 <- SS_xy/SS_xx 
beta_1

# Beta_0
mean(y) - beta_1*mean(x)
beta_0 <- mean(y) - beta_1*mean(x)
beta_0


# A quicker way to fit - Linear regression function 
modelFit <- lm(y ~ x)
# display beta coefficients 
modelFit$coefficients


# y hat (estiamted, fitted outcome) 
head(modelFit$fitted.values)

# Error, y minus y hat 
head(hiv$depression) - head(modelFit$fitted.values)

# And so, sum of squared error,  SSE(beta_0, beta_1) is....
sum((hiv$depression - modelFit$fitted.values)^2)


# Additionally, SSyy
SSyy <- sum(hiv$depression - mean(hiv$depression)^2)

# Correlation (recall addition of Random Variable Part 2-3, to be covered again later)
cor(hiv$RNA, hiv$depression)
(SS_xy / 5000)/(sd(hiv$RNA)*sd(hiv$depression)) # manual calculation for correlation

```











# Question 1. Plot variables, log transformed

### [Task: Plot the same images as above after transforming RNA]{style="color: red;"}

Either log base 2, 10, or natural log is fine

```{r}

```









# Question 2. Compute a 95% Confidence Interval for mean RNA.


### [Task: Evalueate to see whether the 95% coverage contains the null value $H_0: \mu_0=10$.]{style="color: red;"}   
### [Task: Answer: How appropriate is your test of choice for data with such a strong skewness?]{style="color: red;"}   

```{r}
  # Question 2 - 95% CI or significance test...null is mu = 0 
  t.test(hiv$RNA, mu = 0)
```









# Question 3: Fit the model on the original (untransformed) RNA variable and interpret   

### [Task: Write the corresponding equation to the linear model  and fill the Excel answer sheet]{style="color: red;"}  

### [Task: Interpret $\beta_0$ and $\beta_1$. Again, enter your interpretations in the Excel sheet]{style="color: red;"}  

### [Task: Plot the error and evaluate whether it follows a normal distribution or not]{style="color: red;"}   

```{r, fig.width=8, fig.height=3.5}
#QUESTION 3: Write an equation and interpret beta_0 and beta_1 
fitRNA <- lm(depression~RNA, data = hiv)
summary(fitRNA)
beta_0 <- fitRNA$coefficients["(Intercept)"]
beta_1 <- fitRNA$coefficients["RNA"]
ggplot(data = hiv, aes(x = RNA, y = depression)) + 
  geom_point() + 
  theme_classic() + 
  ggtitle("depression score vs. RNA") + 
  geom_abline(slope = beta_1, intercept = beta_0)

```




### histogram and normal qqplot
```{r, fig.width=8, fig.height=3.5}
#QUESTION 4:  Plot an error , to see if they form normal distribution or not 
error <- hiv$depression - fitRNA$fitted.values
par(mfrow = c(1,2))
hist(error, main = "Distribution of error")
qqnorm(error, main = "normal QQ plot (diagonal indicates normal distribution")
par(mfrow = c(1,1))

```

### Residual vs x
```{r, fig.width=8, fig.height=3.5}
par(mfrow = c(1,2))

#QUESTION 4:  Plot an error , to see if they form normal distribution or not 
plot(y = error, x = hiv$RNA, main = "residual plot with the outlier", xlab = "x (RNA)")
plot(y = error[error > -50], x = hiv$RNA[ hiv$RNA < 8000] , main = "residual plot without the outlier", xlab = "x (RNA)", ylab = "error")

par(mfrow = c(1,1))
```


### All plots 
```{r, fig.width=8, fig.height=3.5}
dev.off()
par(mfrow = c(2,2))
#QUESTION 4:  Plot an error , to see if they form normal distribution or not 
plot(y = error[error > -50], x = hiv$RNA[ hiv$RNA < 8000] , main = "Residual plot without the outlier", xlab = "x (RNA)", ylab = "error")
hist(error, main = "Histogram of residual")
plot(y = hiv$depression, x = hiv$RNA, main = "HIV RNA vs Depression", xlab = "x (RNA)", ylab = "Depression")
par(mfrow = c(1,1))
```







# Question 4-1 (natural log): Fit the model on the *Natural log transformed* RNA exposure   
### [Write the corresponding equation and fill the Excel answer sheet]{style="color: red;"}   

```{r, fig.width=8, fig.height=3.5}
# Fit the model 
fitRNA <- lm(depression~RNAe, data = hiv)
summary(fitRNA)
beta_0 <- fitRNA$coefficients["(Intercept)"] %>% unname()
beta_1 <- fitRNA$coefficients["RNAe"] %>% unname()
ggplot(data = hiv, aes(x = RNAe, y = depression)) + 
  geom_point() + 
  theme_classic() + 
  ggtitle("depression score vs. RNA") + 
  geom_abline(slope = beta_1, intercept = beta_0)


ggplot(data = hiv, aes(x = RNA, y = depression)) + 
  geom_point() + 
  theme_classic() + 
  ggtitle("depression score vs. RNA") + 
  geom_abline(slope = beta_1, intercept = beta_0)

```

### Plots

```{r, fig.width=8, fig.height=3.5}
#QUESTION 6:  Plot an error , to see if they form normal distribution or not 
error <- hiv$depression - fitRNA$fitted.values
par(mfrow = c(1,2))
hist(error, main = "Distribution of error")
qqnorm(error, main = "normal QQ plot (diagonal indicates normal distribution \n compare with the QQplot based on natural log transformed RNA")
par(mfrow = c(1,1))

```


### All plots together
```{r, fig.width=8, fig.height=3.5}
dev.off()
par(mfrow = c(2,2))
plot(y = fitRNA$residuals, x = fitRNA$fitted.values , main = "Residual plot without the outlier", xlab = "x (RNA)", ylab = "error")
hist(error, main = "Histogram of residual")
plot(y = hiv$depression, x = hiv$RNAe, main = "HIV RNA vs Depression", xlab = "x (RNA)", ylab = "Depression")
par(mfrow = c(1,1))
```






# Question 4-2 (natural log): Interpret $\beta_1$, additive (1 unit increase) vs. multiplicative (% increase)  

### [Write the two versions of interpretation in the Excel answer sheet, with and without log transformation of RNA]{style="color: red;"}  

As you can see below, when log transformed, beta no longer has a linear interpretation i.e., when converted to the none-log scale, the change of $y$ in response to the increase of x by 1 unit depends on the value of $x$ and no longer fixed across all values of x. However, it is fixed if the  change of x is 1% increase, rather than 1 unit increas. See below.  

```{r, fig.width=8, fig.height=2.5, results='hide'}
# Interpretation in the non-log scale, 1% increase of x has fixed value of beta_1
{beta_0 + beta_1*log(1.01)} - {beta_0 + beta_1*log(1)}
{beta_0 + beta_1*log(5.05)} - {beta_0 + beta_1*log(5)}
{beta_0 + beta_1*log(10.1)} - {beta_0 + beta_1*log(10)}
{beta_0 + beta_1*log(15.15)} - {beta_0 + beta_1*log(15)}



# interpretation in the log scale, 1.0 unit increase has constant value
{beta_0 + beta_1*11} - {beta_0 + beta_1*10}
{beta_0 + beta_1*21} - {beta_0 + beta_1*20}
{beta_0 + beta_1*61} - {beta_0 + beta_1*60}
{beta_0 + beta_1*101} - {beta_0 + beta_1*100}
{beta_0 + beta_1*301} - {beta_0 + beta_1*300}

```








# Question 5-1 (log base 2) : Fit the model on the *log base 2 transformed* RNA exposure

### [Write the equation in the Excel sheet again]{style="color: red;"}

```{r, fig.width=8, fig.height=3.5}
#  Fit the model 
fitRNA <- lm(depression~RNA2, data = hiv)
summary(fitRNA)
beta_0 <- fitRNA$coefficients["(Intercept)"]
beta_1 <- fitRNA$coefficients["RNA2"]
ggplot(data = hiv, aes(x = RNA2, y = depression)) + 
  geom_point() + 
  theme_classic() + 
  ggtitle("depression score vs. RNA") + 
  geom_abline(slope = beta_1, intercept = beta_0)
```

#### Plots
```{r, fig.width=8, fig.height=3.5}

# Plot error, to see if they form normal distribution or not 
error <- hiv$depression - fitRNA$fitted.values
par(mfrow = c(1,2))
hist(error, main = "Distribution of error")
qqnorm(error, main = "normal QQ plot (diagonal indicates normal distribution \n compare with the QQplot based on transformed RNA, log base 2")
par(mfrow = c(1,1))


```












# Additional information about the interpretation of $\beta_1$ (log base 2) :

Compare the model-estimated slope between *log base 2* transformed RNA above vs. the observed trend computed below (they wont' completely agree, since the mostl is not perfect fit)

Our notes tell us that we interpret the intercept coefficient from a linear regression where the covariate is logged (base 2) as the expected change in Y associated with a doubling of X. Let’s see if that relationship holds at least approximately by looking at the average depression score for two values of RNA, one which is twice as large at the other. That is, we should see that every doubly of HIV RNA is associated with about a 3-point increase in depression.

```{r, fig.width=8, fig.height=3.5}
hiv$lowRNA <- ifelse((hiv$RNA>.5 & hiv$RNA<1.5),1,0)
table(hiv$lowRNA)
hiv$medRNA <- ifelse((hiv$RNA>1.5 & hiv$RNA<2.5),1,0)
table(hiv$medRNA)
mean(hiv$depression[hiv$medRNA==1])-mean(hiv$depression[hiv$lowRNA==1])
## Let's look at average depression in people with 
## RNA~=2 vs RNA~=4
hiv$medRNA <- ifelse((hiv$RNA>1.5 & hiv$RNA<2.5),1,0)
table(hiv$medRNA)
hiv$hiRNA <- ifelse((hiv$RNA>3.5 & hiv$RNA<4.5),1,0)
table(hiv$hiRNA)
mean(hiv$depression[hiv$hiRNA==1])-mean(hiv$depression[hiv$medRNA==1])
```







# Question 5-2 (log base 2) : Interpretation 

### [Write the two versions of interpretation in the Excel answer sheet, with and without log base 2 transformation of RNA]{style="color: red;"}  

As before, when x is log base 2 transformed, $\beta_1$ no longer has a linear interpretation, i.e., when converted to the none-log scale, the change of $y$ in response to the increase of x by 1 unit depends on the value of $x$ and no longer fixed across all values of x. However, it is fixed if the change of x double, rather than 1 unit increase. See codes below that show,  when log transformed with base 2, $\beta_1$ has fixed value only when interpreted based on the transformed scale. If converted back to non-log by $2^x$, the change of $y$ in response to the increase of x by 2 folds, not by 1 unit. 

```{r, fig.width=8, fig.height=3.5, results='hide'}
# 1 Unit increase , in non-log scale. Beta_1 has no constant meaning in one unit increase in the non-log scale
x<-1
{beta_0 + beta_1*2^(x + 1)} - {beta_0 + beta_1*2^(x)}
x<-2
{beta_0 + beta_1*2^(x + 1)} - {beta_0 + beta_1*2^(x)}
x<-3
{beta_0 + beta_1*2^(x + 1)} - {beta_0 + beta_1*2^(x)}


# However, if x is doubled, beta_1 offer a constant increase of y in the non-log scale
x<-1
{beta_0 + beta_1*log2(2*x)} - {beta_0 + beta_1*log2(x)} # x= 2 vs 1
x<-2
{beta_0 + beta_1*log2(2*x)} - {beta_0 + beta_1*log2(x)} # x= 4 vs 2
x<-3
{beta_0 + beta_1*log2(2*x)} - {beta_0 + beta_1*log2(x)} # x= 6 vs 3 


# interpretation in the log scale, 1.0 unit increase has constant value as usual 
{beta_0 + beta_1*11} - {beta_0 + beta_1*10}
{beta_0 + beta_1*21} - {beta_0 + beta_1*20}
{beta_0 + beta_1*61} - {beta_0 + beta_1*60}
{beta_0 + beta_1*101} - {beta_0 + beta_1*100}
{beta_0 + beta_1*301} - {beta_0 + beta_1*300}

```
















### Optional, Log 10

```{r, fig.width=8, fig.height=3.5}
#  Fit the model 
fitRNA <- lm(depression~log10(RNA), data = hiv)
summary(fitRNA)
beta_0 <- fitRNA$coefficients["(Intercept)"]
beta_1 <- fitRNA$coefficients["RNA2"]
ggplot(data = hiv, aes(x = RNA2, y = depression)) + 
  geom_point() + 
  theme_classic() + 
  ggtitle("depression score vs. RNA") + 
  geom_abline(slope = beta_1, intercept = beta_0)

# Plot error, to see if they form normal distribution or not 
error <- hiv$depression - fitRNA$fitted.values
par(mfrow = c(1,2))
hist(error, main = "Distribution of error")
qqnorm(error, main = "normal QQ plot (diagonal indicates normal distribution \n compare with the QQplot based on transformed RNA, log base 2")
par(mfrow = c(1,1))
```











# Question 6: Interpretation of the intercept.    

### This time, the exposure is Age and the outcome (response variable) is depression score.    

### Be careful about the range of Age in the original data. Do not over-interpret $\beta_0$. If necessary, standardize the values of x.

### [Write the corresponding equation ]{style="color: red;"}

### [Interpret $\beta_0$, that is, what is the meaning of $\hat{y} = \hat{\beta_0} + \hat{\beta_1} \times x$, where $x = 0$?]{style="color: red;"}

```{r, fig.width=8, fig.height=3.5}

#  Fit the model 
fitAge <- lm(depression~age, data = hiv)
summary(fitAge)
beta_0 <- fitAge$coefficients["(Intercept)"]
beta_1 <- fitAge$coefficients["age"]

grid.arrange(
  ggplot(data = hiv, aes(x = age, y = depression)) + 
    geom_point() + 
    theme_classic() + 
    ggtitle("depression score vs. age") + 
    geom_abline(slope = beta_1, intercept = beta_0) + 
    xlim(c(0,60)),
  ggplot(data.frame(x = fitAge$fitted.values), aes(x)) + 
    geom_histogram() + 
    theme_classic() + 
    ggtitle("histogram of residuals"), 
  ncol = 2
)


```


### What is wrong with the value of $\beta_0$ here? 
```{r, fig.width=8, fig.height=3.5}
hiv$age_center <- hiv$age - mean(hiv$age)
#  Fit the model 
fitAge_center <- lm(depression~age_center, data = hiv)
summary(fitAge_center)
beta_0 <- fitAge_center$coefficients["(Intercept)"]
beta_1 <- fitAge_center$coefficients["age_center"]

grid.arrange(
  ggplot(data = hiv, aes(x = age_center, y = depression)) + 
    geom_point() + 
    theme_classic() + 
    ggtitle("depression score vs. age - CENTERED") + 
    geom_abline(slope = beta_1, intercept = beta_0),
  ggplot(data.frame(x = fitAge$fitted.values), aes(x)) + 
    geom_histogram() + 
    theme_classic() + 
    ggtitle("histogram of residuals"), 
  ncol = 2
)

```


### Plot the estimated slope with and without centering, and interpret $\beta_0$ and $\beta_1$ for both results
```{r, fig.width=8, fig.height=3.5}
grid.arrange(
  ggplot(data = hiv, aes(x = age_center, y = depression)) + 
    geom_point() + 
    theme_classic() + 
    ggtitle("depression score vs. age - CENTERED") + 
    geom_abline(slope = fitAge_center$coefficients["age_center"], intercept = fitAge_center$coefficients["(Intercept)"]),
  ggplot(data = hiv, aes(x = age, y = depression)) + 
    geom_point() + 
    theme_classic() + 
    ggtitle("depression score vs. age") + 
    geom_abline(slope = fitAge$coefficients["age"], intercept = fitAge$coefficients["(Intercept)"]),
  ncol = 2
)

```









# Question 7: Binary exposure variable, female(x = 1) vs male (x = 1)

### [Write the corresponding equation]{style="color: red;"}

### [Interpret $\beta_0$, that is, what is the meaning of $\hat{y} = \hat{\beta_0} + \hat{\beta_1} \times x$, where $x = 0$?]{style="color: red;"}

### [Interpret $\beta_1$.]{style="color: red;"}

### [Interpret the two plots]{style="color: red;"}

```{r, fig.width=8, fig.height=3.5}
#  Fit the model 
fitFemale <- lm(depression~female, data = hiv)
summary(fitFemale)
beta_0 <- fitAge$coefficients["(Intercept)"]
beta_1 <- fitAge$coefficients["female1"]

grid.arrange(
  ggplot(data = hiv, aes(x = female, y = depression)) + 
    geom_point() + 
    theme_classic() + 
    ggtitle("depression score vs. sex") + 
    geom_abline(slope = beta_1, intercept = beta_0),
  ggplot(data.frame(x = fitFemale$fitted.values), aes(x)) + 
    geom_histogram() + 
    theme_classic() + 
    ggtitle("histogram of residuals"), 
  ncol = 2
)
```
